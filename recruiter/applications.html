<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Applications - Recruiter</title>
  <link rel="stylesheet" href="../styles.css" />
  <style>
    .app-card{padding:14px}
    .app-name{font-size:20px;font-weight:900;margin:0 0 6px}
    .app-meta{margin:4px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div data-include="header"></div>

  <main class="page-main">
    <div class="row">
      <a class="btn" href="dashboard.html">‚Üê Back</a>
      <button class="btn" id="logoutBtn" type="button">Logout</button>
    </div>

    <h1 class="section-title" style="margin-top:14px;">Applications</h1>
    <p class="meta" id="sub">Loading...</p>

    <div id="appsBox" class="grid" style="margin-top:14px;"></div>
  </main>

  <script src="../js/app.js"></script>
  <script src="../js/script.js"></script>
  <script src="../js/partials.js"></script>

  <script>
    const user = requireLogin("recruiter/dashboard.html");
    if (user && user.role !== "recruiter") {
      alert("Recruiter access only.");
      window.location.href = "../index.html";
    }

    document.getElementById("logoutBtn").addEventListener("click", logout);

    const jobId = new URLSearchParams(location.search).get("job_id");

    function esc(s){
      return String(s||"").replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
    }
    function digitsOnly(s){ return String(s||"").replace(/\D/g,""); }

    function appCard(a){
      const phoneDigits = digitsOnly(a.applicant_phone);
      const callBtn = phoneDigits
        ? `<a class="btn btn-primary" href="tel:${phoneDigits}">üìû Call</a>`
        : "";

      const waBtn = phoneDigits
        ? `<a class="btn" target="_blank" href="https://wa.me/91${phoneDigits}">WhatsApp</a>`
        : "";

      return `
        <div class="card app-card">
          <div class="app-name">${esc(a.applicant_name)}</div>
          <div class="app-meta"><strong>Phone:</strong> ${esc(a.applicant_phone)}</div>
          ${a.applicant_email ? `<div class="app-meta"><strong>Email:</strong> ${esc(a.applicant_email)}</div>` : ""}
          ${a.message ? `<div class="app-meta"><strong>Message:</strong> ${esc(a.message)}</div>` : ""}
          <div class="row" style="margin-top:10px;">
            ${callBtn}
            ${waBtn}
          </div>
        </div>
      `;
    }

    async function loadApplications(){
      const sub = document.getElementById("sub");
      const box = document.getElementById("appsBox");

      if (!jobId){
        sub.textContent = "No job selected.";
        return;
      }

      sub.textContent = "Loading applications...";
      box.innerHTML = "";

      try{
        // Fetch applications for this job with ownership check
        const url = API("applications_list.php") + `?job_id=${encodeURIComponent(jobId)}&recruiter_id=${encodeURIComponent(user.id)}`;
        const res = await fetch(url);
        const data = await res.json();

        if(!data.ok){
          sub.textContent = data.message || "Failed to load applications.";
          return;
        }

        const apps = data.applications || [];
        if(apps.length === 0){
          sub.textContent = "No applications yet.";
          return;
        }

        sub.textContent = `Total applications: ${apps.length}`;
        box.innerHTML = apps.map(appCard).join("");
      }catch(e){
        console.error(e);
        sub.textContent = "Server error. Check XAMPP.";
      }
    }

    loadApplications();
  </script>

  <div data-include="footer"></div>
</body>
</html>
</html>
